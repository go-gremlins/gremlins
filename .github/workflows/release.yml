name: release
on:
  push:
    tags: [ 'v*' ]

permissions:
  contents: write
  packages: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Fetch all tags
        run: git fetch --force --tags
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version-file: 'go.mod'
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v2
        with:
          distribution: goreleaser
          version: latest
          args: release --rm-dist
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_PAT }}
  documentation:
    if: ${{ github.event_name != 'pull_request' }}
    needs: [ goreleaser ]
    steps:
      - name: Set version env
        # v1.2.3 ->
        #   GR_FULL_VERSION=1.2.3
        #   GR_SHORT_VERSION=v1.2
        #   GR_PATCH_VERSION=2
        run: |
          echo "GR_FULL_VERSION=$(echo $GITHUB_REF | cut -c2-)" >> $GITHUB_ENV
          echo "GR_SHORT_VERSION=$(echo $GITHUB_REF | cut -d '.' -f 1,2)" >> $GITHUB_ENV
          echo "GR_PATCH_VERSION=$(echo $GITHUB_REF | cut -d '.' -f 3)" >> $GITHUB_ENV
      - name: Build latest documentation
        # If patch is 0, it is a new release; set as new default
        if: ${{ env.GR_PATCH_VERSION == "0" }}
        uses: ./.github/workflows/docs.yml
        with:
          short_version: ${{ env.GR_SHORT_VERSION }}
          full_version: ${{ env.GR_FULL_VERSION }}
          label: latest
          default: true
      - name: Build patch documentation
        # If patch is not 0, it is a patch release; don't set as default
        if: ${{ env.GR_PATCH_VERSION != "0" }}
        uses: ./.github/workflows/docs.yml
        with:
          short_version: ${{ env.GR_SHORT_VERSION }}
          full_version: ${{ env.GR_FULL_VERSION }}
          default: false
